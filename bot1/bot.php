<?php
error_reporting(1) ; // –≤–∫–ª—é—á–∏—Ç—å –≤—Å–µ –≤–∏–¥—ã –æ—à–∏–±–æ–∫, –≤–∫–ª—é—á–∞—è  E_STRICT
ini_set('display_errors', 'On');  // –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–º–∏–º–æ –ª–æ–≥–æ–≤
//$dbp = 's';
require 'classes/Curl.php';
require 'classes/PDO.php';
require '../vendor/autoload.php';
/**
 * @var \TelegramBot\Api\BotApi $bot
 */
$curl = new Curl();
$json = file_get_contents('php://input'); // –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$action = json_decode($json, true); // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º JSON

// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ë–î –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞
$set_bot = DB::$the->query("SELECT * FROM `sel_set_bot` ");
$set_bot = $set_bot->fetch(PDO::FETCH_ASSOC);

$message	= $action['message']['text']; // —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$chat		= $action['message']['chat']['id']; // ID —á–∞—Ç–∞
$chat		= '213586898'; // ID —á–∞—Ç–∞
$username	= $action['message']['from']['username']; // username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$first_name	= $action['message']['from']['first_name']; // –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$last_name	= $action['message']['from']['last_name']; // —Ñ–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$token		= $set_bot['token']; // —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
//291326668:AAEEkeDIluD-__nGzWl-qUetY_pwjDE6sSE
//199870151:AAGiGx8yksHxX-oP_78N-0obO5tNzGae4UM

$bot = new \TelegramBot\Api\BotApi($token);
$slash = false;
if(mb_substr($message, 0, 1) == '/'){
    $message = mb_substr($message, 1);
    $slash = true;
};
//$bot->sendMessage($chat, $message);

// –ï—Å–ª–∏ –±–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—Å–µ!
if($set_bot['on_off'] == "off") exit;

// –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
$user = DB::$the->query("SELECT ban,cat FROM `sel_users` WHERE `chat` = {$chat} ");
$user = $user->fetch(PDO::FETCH_ASSOC);

// –ï—Å–ª–∏ —é–∑–µ—Ä –∑–∞–±–∞–Ω–µ–Ω, –æ—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è –Ω–µ–≥–æ –≤—Å–µ!
if($user['ban'] == "3") exit;


if ($message == "‚Ü™–ù–∞–∑–∞–¥") {

	DB::$the->prepare("UPDATE sel_users SET cat=? WHERE chat=? ")->execute(array("0", $chat));
	DB::$the->prepare("UPDATE sel_keys SET block=? WHERE block_user=? ")->execute(array("0", $chat));
	DB::$the->prepare("UPDATE sel_keys SET block_time=? WHERE block_user=? ")->execute(array('0', $chat));
	DB::$the->prepare("UPDATE sel_keys SET block_user=? WHERE block_user=? ")->execute(array('0', $chat));
	DB::$the->prepare("UPDATE sel_users SET id_key=? WHERE chat=? ")->execute(array('0', $chat));
	DB::$the->prepare("UPDATE sel_users SET pay_number=? WHERE chat=? ")->execute(array('pay_number', $chat));

}

if ($message == "üî∑–î–æ–ø. –∏–Ω—Ñ–æ") {
	$info = DB::$the->query("SELECT request, response FROM `sel_addinfo`");
	$info = $info->fetchAll();
	$keys = [];
	$msg = "–í—ã–±–µ—Ä–∏—Ç–µ :\n";
	$i = 0;
	$k = 0;
	foreach ($info as $el){
		$keys[][] = urldecode($el['request']);
		$msg .= urldecode($el['request'])."\n";

	}
	$keys[][] = '‚Ü™–ù–∞–∑–∞–¥';
	$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keys, null, true);
	$bot->sendMessage($chat, $msg, false, null, null, $keyboard);
	exit;
}

$info = DB::$the->query("SELECT request, response FROM `sel_addinfo`");
$info = $info->fetchAll();
foreach ($info as $el) {
	if (urldecode($el['request']) == $message) {
		$bot->sendMessage($chat, urldecode($el['response']));
		exit;
	}
}


// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
$vsego = DB::$the->query("SELECT chat FROM `sel_users` WHERE `chat` = {$chat} ");
$vsego = $vsego->fetchAll();

// –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ
if(count($vsego) == 0){

// –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ë–î
	$params = array('username' => $username, 'first_name' => $first_name, 'last_name' => $last_name,
		'chat' => $chat, 'time' => time() );

	$q = DB::$the->prepare("INSERT INTO `sel_users` (username, first_name, last_name, chat, time) 
VALUES (:username, :first_name, :last_name, :chat, :time)");
	$q->execute($params);
}

// –ï—Å–ª–∏ —Å–¥–µ–ª–∞–Ω –∑–∞–ø—Ä–æ—Å –æ–ø–ª–∞—Ç–∞
if ($message == "–æ–ø–ª–∞—Ç–∞" or $message == "–û–ø–ª–∞—Ç–∞") {
	require_once("./verification.php");
    exit;
}

// –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
if ($message == "–∑–∞–∫–∞–∑—ã" or $message == "–ó–∞–∫–∞–∑—ã") {
	$chat = escapeshellarg($chat);
	exec('bash -c "exec nohup setsid php ./orders.php '.$chat.' > /dev/null 2>&1 &"');
	exit;

}

// –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â—å
/*if ($message == "–ø–æ–º–æ—â—å" or $message == "–ü–æ–º–æ—â—å" or $message == "üÜò–ü–æ–º–æ—â—å") {


	$text = "–°–ü–ò–°–û–ö –ö–û–ú–ê–ù–î
–û–ø–ª–∞—Ç–∞ - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã
–ó–∞–∫–∞–∑—ã - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤
–û—Ç–º–µ–Ω–∞ –∏–ª–∏ '0' - –æ—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞
–ü–æ–º–æ—â—å - –≤—ã–∑–æ–≤ —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥
";

	$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup([['‚ôªÔ∏è–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é'], ['üì¶–û–ø–ª–∞—Ç–∞', 'üí∞–ó–∞–∫–∞–∑—ã'], ['üÜò–ü–æ–º–æ—â—å']], null, true);

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
	$bot->sendMessage($chat, $text, false, null, null, $keyboard);
	exit;
}*/
if ($message == "0" or $message == "‚Ü™Ô∏è–û—Ç–º–µ–Ω–∞" or $message == "–û—Ç–º–µ–Ω–∞" or $message == "Otmena") {

	DB::$the->prepare("UPDATE sel_users SET cat=? WHERE chat=? ")->execute(array("0", $chat));
	DB::$the->prepare("UPDATE sel_keys SET block=? WHERE block_user=? ")->execute(array("0", $chat));
	DB::$the->prepare("UPDATE sel_keys SET block_time=? WHERE block_user=? ")->execute(array('0', $chat));
	DB::$the->prepare("UPDATE sel_keys SET block_user=? WHERE block_user=? ")->execute(array('0', $chat));
	DB::$the->prepare("UPDATE sel_users SET id_key=? WHERE chat=? ")->execute(array('0', $chat));
	DB::$the->prepare("UPDATE sel_users SET pay_number=? WHERE chat=? ")->execute(array('pay_number', $chat));
	DB::$the->prepare("UPDATE sel_users SET ban=ban+1 WHERE chat=? ")->execute(array($chat));
	$warn = DB::$the->query("SELECT ban FROM sel_users WHERE chat= {$chat} order by id limit 1");
	$warn = $warn->fetch(PDO::FETCH_ASSOC)['ban'];
	switch($warn){
		case 1:
			$warn = '–ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!';
			break;
		case 2:
			$warn = '–í—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!';
			break;
		case 3:
			$warn = '–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–±–∞–Ω–µ–Ω—ã!';
			break;
	}

	$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup([['‚ôªÔ∏è–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é']/*, ['üì¶–û–ø–ª–∞—Ç–∞', 'üí∞–ó–∞–∫–∞–∑—ã', '‚Ü™Ô∏è–û—Ç–º–µ–Ω–∞'], ['üÜò–ü–æ–º–æ—â—å']*/], null, true);
	$text = "üö´ –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω!
	–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä –±–µ–∑ –æ–ø–ª–∞—Ç—ã –±–æ–ª–µ–µ —Ç—Ä–µ—Ö —Ä–∞–∑.
	{$warn}";
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
	$bot->sendMessage($chat, $text, false, null, null, $keyboard);

	exit;
}
// –ü–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—ã—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –≤ —ç–º–æ–¥–∑–∏
function idToEmoji($id){
	if (isset($id)){
		$numbers = str_split($id);
		$numbers_result = [];
		foreach ($numbers as $number){
			switch ($number){
				case 0:
					$numbers_result[] = '0‚É£';
					break;
				case 1:
					$numbers_result[] = '1‚É£';
					break;
				case 2:
					$numbers_result[] = '2‚É£';
					break;
				case 3:
					$numbers_result[] = '3‚É£';
					break;
				case 4:
					$numbers_result[] = '4‚É£';
					break;
				case 5:
					$numbers_result[] = '5‚É£';
					break;
				case 6:
					$numbers_result[] = '6‚É£';
					break;
				case 7:
					$numbers_result[] = '7‚É£';
					break;
				case 8:
					$numbers_result[] = '8‚É£';
					break;
				case 9:
					$numbers_result[] = '9‚É£';
					break;
			}
		}
	}
	return isset($numbers_result) ? implode($numbers_result) : $id;
}
// –ü–µ—Ä–µ–≤–æ–¥–∏–º —ç–º–æ–¥–∑–∏ –≤ –æ–±—ã—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
function emojiToId($id){
	$numbers_result = $id;
	$emodji = ['0‚É£', '1‚É£', '2‚É£', '3‚É£', '4‚É£', '5‚É£', '6‚É£', '7‚É£', '8‚É£', '9‚É£'];
	$nums = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
	$numbers_result = str_replace($emodji, $nums, $numbers_result);
	
	return $numbers_result;
}

//$message = 'raj143';

if(!empty($message) && strpos($message, 'city') === 0){
	$message = mb_substr($message, 4);
	$cat = DB::$the->query("SELECT id FROM `sel_category` WHERE `id` = '".$message."' ");
	$cat = $cat->fetchAll();
	if (count($cat) != 0){
		$output = "";
		require_once "./select.php";
		exit;
	} else{
		$bot->sendMessage($chat, '–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞!');
	}
}
if(!empty($message) && strpos($message, 'raj') === 0){
	$message = mb_substr($message, 3);
	
	$cat = DB::$the->query("SELECT id FROM `sel_subcategory` WHERE `id` = '".$message."' ");
	$cat = $cat->fetchAll();
	if (count($cat) != 0){
		$output = "";
		require_once "./select_raj.php";
		exit;
	} else{
		$bot->sendMessage($chat, '–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞!');
	}
}
/*if($user['cat'] > 0 && !empty($message)){
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞
	$cat = DB::$the->query("SELECT id FROM `sel_subcategory` WHERE `id_cat` = '".$user['cat']."' ");
	$cat = $cat->fetchAll();

	if (count($cat) != 0)
	{
		$message = urlencode($message);
		require_once "./select.php";
		exit;
	}
}*/

//$message = '–ü–†–ê–ô–°';
if ($message == '–ü–†–ê–ô–°' || $message == '33'){
	$cats = DB::$the->query("SELECT id,name,mesto FROM `sel_category` order by `mesto` ");
	$cats = $cats->fetchAll();
//	var_dump($cats);
//	die;
	$text = "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:\n";
	$text .= "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n";
	$keys = [];
	$keys[][] = '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é';
	$i = 0;
	$k = 0;
	if (count($cats) > 0){
		foreach($cats as $cat) {
			$subcats = DB::$the->query("SELECT id, name, mesto FROM sel_subcategory WHERE id_cat = ".$cat['id']." order by mesto ");
			$subcats = $subcats->fetchAll();
			if (count($subcats) > 0) {
				$text .= 'üè†'.$cat['mesto'] . '. ' . urldecode($cat['name']) . ": \n"; // –≠–¢–û –ù–ê–ó–í–ê–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ô
				$text .= "[ –ù–∞–∂–º–∏—Ç–µ üëâ /city".$cat['id']."]\n";
				$text .= "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ";
				/*foreach ($subcats as $subcat) {
					$text .= urldecode($subcat['name']) . " (" . $subcat['amount'] . "—Ä—É–±) - –æ—Ç–≤–µ—Ç \"" .
						$subcat['id'] . "\" \n"; // –≠–¢–û –ù–ê–ó–í–ê–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ô
					$keys[][] = idToEmoji($subcat['id']) . " - " . urldecode($cat['name']) . " - ". urldecode($subcat['name']) .
						" (" . $subcat['amount'] ."—Ä—É–±)";
				}*/
				$text .= "\n";
			}
		}
	}
	$keys[][] = '–ù–∞–∑–∞–¥';
	$text .= "\n".$set_bot['footer'];


	$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keys, null, true);
	$bot->sendMessage($chat, $text, false, null, null, $keyboard);
	exit;
}

$text = urldecode($set_bot['hello'])."\n\n";
$text .= "\n".$set_bot['footer'];
$keys[][] = '–ü–†–ê–ô–°';
$keys[][] = '–í—ã—Ö–æ–¥';
$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keys, null, true);
$bot->sendMessage($chat, $text, false, null, null, $keyboard);
